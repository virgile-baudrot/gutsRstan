---
title: "'rstanguts': Bayesian inference of GUTS models with R using Stan language"
preprint: false
author: 
  - name: Virgile Baudrot
    affiliation: 1
    corresponding: true
    email: virgile.baudrot@posteo.net
  - name: Sandrine Charles
    affiliation: 1
affiliation:
  - code: 1
    address: UMR CNRS 5558 LBBE, UniversitÃ© Lyon 1, 43 Boulevard du 11 Novembre 1918, 69100 Villeurbanne
abstract: >
  The toxicokinetic-toxicodynamic (TKTD) modeling approach proved to be of particular interest in strengthening the Environmental Risk Assessment (ERA) of chemicals compounds.
  TKTD models describe the time-course of processes leading to toxicity at the level of organisms.
  These models may include all mechanisms from the toxicokinetics part describing the compound fate from external concentration to internal kinetics (e.g., exposure, uptake, elimination, biotransformation, internal distribution), and translate the internal concentration into toxicodynamics covering alteration of cells and organs functioning that can eventually lead to a toxic effect at the organism level (e.g., mortality, reduced reproduction, abnormal behavior) then affecting the population dynamic.
  While an integrative mathematical framework as GUTS offers an efficient theoretical approach, its practical use for parameter estimation is challenging (from model implementation to parameter estimation), especially with time-variable exposure.
  Faced with this difficulty, Bayesian approach for GUTS models has multiple advantages as (i) using all data provided by the experiments, (ii) taking into account the knowledge from experts and/or previous studies, (iii) being still relevant for complex model with small data set, and (iv) handling uncertainties by providing distributions of parameter posteriors.
  To facilitate the access to Bayesian fitting of GUTS models based on ordinary differential equations, we implemented GUTS models within R using the the Stan language dedicated to Bayesian statistics. 
  In this paper, we compare the result of models implementation (goodness-of-fit and speedups) and provided some guidelines for using Bayesian approach in ecotoxicology.
  For survival analysis of organisms in response to a chemical stressor, the General Unified Threshold model of Survival (GUTS) is today recognized as a suitable and powerful TKTD framework incorporating two complimentary death mechanisms: Stochastic Death (GUTS-SD) and Individual Tolerance (GUTS-IT), from which a large range of existing models can be derived.
header-includes: >
  \usepackage{lipsum}
bibliography: ../../BIBLIOGRAPHY/00_VB_Biblio.bib
output: 
  rticles::peerj_article:
    base_format: rmarkdown::pdf_document # bookdown::pdf_document2 # for using \@ref()
editor_options: 
  chunk_output_type: console
---

# Introduction {-}

References:  [@Vehtari2017], [@Carpenter2017stan]


# Mathematical description of GUTS models {-}

References to look at: [@Jager2018GUTSbook], [@Jager2011], [@Delignette-Muller2017], [@Baudrot2018EST]

# Implementation of 'rstanguts'

References to look at: [@Delignette-Muller2017], [@Baudrot2018EST], [@Baudrot2018morse]

The implementation was done using the *rstantools* package [@Gabry2017rstantools].


# Practical Application Example

The package `rstanguts` is devoted to the analysis of data from standard toxicity
tests. It provides a simple workflow to calibrate GUTS models.
In this section, we illustrate a typical use of `rstanguts` on survival data, which can be followed
step-by-step to analyze new datasets as it is also described in the vignette `getting-started`.

```{r getting-started, echo=FALSE, message=FALSE}
library(rstanguts)
vignette("getting-started", package="rstanguts")
```

## Load data

In the following example, we use a classical data set of *Gammarus pulex* exposed to diazinon [@Ashauer2010] as used in the R package *GUTS* from @Albert2016 [@Albert2017GUTS].
This data set is already in the package, so you can have access to the data simply by using the `data()` function.

```{r data_diazinon, echo=FALSE}
data("data_Diazinon")
```

## Fit all GUTS models

```{r fit_diazinon, cache=TRUE, echo=FALSE, message=FALSE, eval=FALSE}
# OPTION for the number of cores:
options(mc.cores = 3)

# (6) fit the TK-TD model SD
fit_SD_diaz <- stan_guts(data_Diazinon, model_type = "SD")

# (7) fit the TK-TD model IT
fit_IT_diaz <- stan_guts(data_Diazinon, model_type = "IT")

# (8) fit the TK-TD model IT with distribution 'lognormal'
fit_IT_lN_diaz <- stan_guts(data_Diazinon, model_type = "IT", distribution = "lognormal")

# (9) fit the TK-TD model PROPER with distribution 'loglogistic'
fit_PROPER_ll_diaz <- stan_guts(data_Diazinon, model_type = "PROPER")

# (10) fit the TK-TD model PROPER with distribution 'lognormal'
fit_PROPER_lN_diaz <- stan_guts(data_Diazinon, model_type = "PROPER", distribution = "lognormal")
```

```{r load, echo=FALSE}
load(file = "../vignettes/data_fit/fit_SD_diaz.rda")
load(file = "../vignettes/data_fit/fit_IT_diaz.rda")
load(file = "../vignettes/data_fit/fit_IT_lN_diaz.rda")
load(file = "../vignettes/data_fit/fit_PROPER_ll_diaz.rda")
load(file = "../vignettes/data_fit/fit_PROPER_lN_diaz.rda")
```

## Plot results

```{r plt_fit_diaz_rate, cache=TRUE, echo=FALSE}
plot_stanguts(fit_SD_diaz)
plot_stanguts(fit_IT_diaz)
plot_stanguts(fit_PROPER_ll_diaz)
plot_stanguts(fit_PROPER_lN_diaz)
```

## Plot of number of survivors

```{r plt_fit_diaz_nbr, cache=TRUE, echo=FALSE}
plot_stanguts(fit_SD_diaz, data_type = "Number")
plot_stanguts(fit_IT_diaz, data_type = "Number")
plot_stanguts(fit_PROPER_ll_diaz, data_type = "Number")
plot_stanguts(fit_PROPER_lN_diaz, data_type = "Number")
```

## Further analysis with the use of `rstan` dedicated packages as `rstanarm`, `loo` and `bayesplot`

Conversion to `stanfit` object

```{r convert_stanfit, cache=TRUE}
stanfit_SD_diaz <- stanguts_to_stanfit(fit_SD_diaz)
stanfit_IT_diaz <- stanguts_to_stanfit(fit_IT_diaz)
stanfit_PROPER_ll_diaz <- stanguts_to_stanfit(fit_PROPER_ll_diaz)
stanfit_PROPER_lN_diaz <- stanguts_to_stanfit(fit_PROPER_lN_diaz)
```

Then using the package `loo`, we have to extract the log_likelihood matrix
```{r extract_log_lik, echo=FALSE}
library(loo)
log_lik_SD_diaz <- extract_log_lik(stanfit_SD_diaz, parameter_name = "log_lik")
log_lik_IT_diaz <- extract_log_lik(stanfit_IT_diaz, parameter_name = "log_lik")
log_lik_PROPER_ll_diaz <- extract_log_lik(fit_PROPER_ll_diaz, parameter_name = "log_lik")
log_lik_PROPER_lN_diaz <- extract_log_lik(fit_PROPER_lN_diaz, parameter_name = "log_lik")
```

Use Stan dedicated package

```{r loo_stanfit, cache=TRUE, echo=FALSE}
loo_SD_diaz <- loo(log_lik_SD_diaz, save_psis = TRUE)
loo_IT_diaz <- loo(log_lik_IT_diaz, save_psis = TRUE)
loo_PROPER_ll_diaz <- loo(log_lik_PROPER_ll_diaz, save_psis = TRUE)
loo_PROPER_lN_diaz <- loo(log_lik_PROPER_lN_diaz, save_psis = TRUE)
```


<!-- 
HELP TO WRITE THE MANUSCRIPT - To be removed
 -->

# Help to write the manuscript {-}

## Some \LaTeX{} Examples {-}

Use section and subsection commands to organize your document. \LaTeX{} handles all the formatting and numbering automatically. Use ref and label commands for cross-references.

## Figures and Tables {-}

Use the table and tabular commands for basic tables --- see Table \@ref(tab:widgets), for example. You can upload a figure (JPEG, PNG or PDF) using the project menu. To include it in your document, use the includegraphics command as in the code for Figure \@ref(fig:view) below.

Standard \LaTeX references will work as well (e.g. Fig. \ref{fig:view}).

<!-- There are three ways to include figures: -->
<!-- 1. The LaTeX way -->
<!-- 

\begin{figure}[ht]
\centering
\includegraphics[width=\linewidth]{view}
\caption{An example image.}
\label{fig:view}
\end{figure} 

 -->

<!-- 2. The RMarkdown way -->

```{r view, out.width = "100%", fig.cap = "An example image.", echo = FALSE}
knitr::include_graphics("view.pdf")
```


<!-- 3. The pandoc way -->
<!-- 

![An example image. Text *can* be processed with markdown.](view.pdf){#view width = 100%}

 -->

<!-- 
\begin{table}[ht]
\centering
\begin{tabular}{l|r}
Item & Quantity \\\hline
Widgets & 42 \\
Gadgets & 13
\end{tabular}
\caption{\label{tab:widgets}An example table.}
\end{table}
-->

Item     Quantity
------- ---------
Widgets        42
Gadgets        13

Table: (\#tab:widgets) An Example Table.


## Mathematics {-}

\LaTeX{} is great at typesetting mathematics. Let $X_1, X_2, \ldots, X_n$ be a sequence of independent and identically distributed random variables with $\text{E}[X_i] = \mu$ and $\text{Var}[X_i] = \sigma^2 < \infty$, and let
$$S_n = \frac{X_1 + X_2 + \cdots + X_n}{n}
      = \frac{1}{n}\sum_{i}^{n} X_i$$
denote their mean. Then as $n$ approaches infinity, the random variables $\sqrt{n}(S_n - \mu)$ converge in distribution to a normal $\mathcal{N}(0, \sigma^2)$.

## Lists {-}

You can make lists with automatic numbering \dots


1. Like this,
1. and like this.

or bullet points...

- Like this,
- and like this.

or with descriptions...

- **Word** Definition
- **Concept** Explanation
- **Idea** Text


We hope you find write\LaTeX\ useful for your PeerJ submission, and please let us know if you have any feedback. Further examples with dummy text are included in the following pages.

# Methods {-}

\lipsum[4] 

\begin{equation}
\cos^3 \theta =\frac{1}{4}\cos\theta+\frac{3}{4}\cos 3\theta
\label{eq:refname2}
\end{equation}

\lipsum[5] 

## Subsection {-}

\lipsum[6] 

\paragraph{Paragraph} \lipsum[7] 
\paragraph{Paragraph} \lipsum[8] 

## Subsection {-}

\lipsum[9] 

<!-- \begin{figure}[ht]\centering -->
<!-- \includegraphics[width=\linewidth]{results} -->
<!-- \caption{In-text Picture} -->
<!-- \label{fig:results} -->
<!-- \end{figure} -->

```{r results, fig.width = 5, fig.height = 4, out.width = "100%", fig.cap = "In-text Picture", echo = FALSE}
time = seq(1.5, 8, 0.1)
plot(time, sin(time), type = "l", xlab = "time [s]", ylab = "amplitude [m]", 
     cex.main = 2, col = "blue", lwd = 3, font = 2, font.main = 2)
```


Reference to Figure \@ref(fig:results).

# Results and Discussion {-}

\lipsum[10] 

## Subsection {-}

\lipsum[11] 

### Subsubsection {-}

\lipsum[12] 

### Subsubsection {-}

\lipsum[14] 

## Subsection {-}

\lipsum[15-20] 

# Acknowledgments {-}

So long and thanks for all the fish.

# References
